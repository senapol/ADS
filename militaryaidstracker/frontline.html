<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ukraine Frontline Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        #map { height: 600px; }
        #slider-container { text-align: center; margin: 10px; }
        input[type="range"] { width: 80%; }
    </style>
</head>
<body>
    <h2 style="text-align: center;">Ukraine Frontline Tracker</h2>

    <div id="slider-container">
        <input type="range" id="date-slider" min="0" max="0" value="0">
        <p id="selected-date">Date: </p>
    </div>

    <div id="map"></div>

    <script>
        let map = L.map('map').setView([48, 32], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        let markers = L.layerGroup().addTo(map);
        let frontlineLayer = L.layerGroup().addTo(map);
        let slider = document.getElementById("date-slider");
        let dateLabel = document.getElementById("selected-date");

        let uniqueDates = [];

        // Load event data and initialize slider
        d3.csv("ACLED_Ukraine_Reduced.csv").then(data => {
            let eventDates = [...new Set(data.filter(d => d.event_type === "Battles")
                                      .map(d => new Date(d.event_date).toISOString().split('T')[0]))];

            uniqueDates = eventDates.sort();

            if (uniqueDates.length > 0) {
                slider.max = uniqueDates.length - 1;
                slider.value = 0;
                updateMap(0);
            }
        });

        slider.addEventListener("input", function () {
            let index = parseInt(this.value);
            updateMap(index);
        });

        function updateMap(index) {
            if (index >= uniqueDates.length) return;

            let selectedDate = uniqueDates[index];
            dateLabel.innerText = "Date: " + selectedDate;
            console.log("Updating map for date:", selectedDate);

            markers.clearLayers();
            frontlineLayer.clearLayers();

           fetch(`http://127.0.0.1:5000/frontline?date=${selectedDate}`)
            .then(response => response.json())
            .then(data => {
                if (!data.centroids.length) {
                    console.warn("No frontline data for", selectedDate);
                    return;
                }

                let centroids = data.centroids;

                centroids.forEach(c => L.circleMarker(c, { color: 'red', radius: 5 }).addTo(markers));
                L.polyline(centroids, { color: 'blue', weight: 3, opacity: 1 }).addTo(frontlineLayer);
                console.log("Frontline drawn:", centroids);
            })
            .catch(error => console.error("Error fetching frontline:", error));
        }
    </script>

</body>
</html>
